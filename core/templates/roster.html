{% extends "base.html" %}
{% block content %}
  <div class="max-w-5xl mx-auto">
    <!-- Header + primary actions -->
    <div class="flex flex-col gap-4 lg:flex-row lg:items-start lg:justify-between mb-8">
      <div>
        <h1 class="page-header">
          Master Roster
        </h1>
        <p class="mt-1 text-sm text-slate-500">
          Keep your players organized by section so you can send the right parts to the right people every time.
        </p>
      </div>

      <div class="gap-2 lg:justify-end">
        <!-- Upload roster -->
        <form id="upload-roster-form"
          action="{% url 'upload_roster' %}"
          method="post"
          enctype="multipart/form-data"
          class="inline-block">
          {% csrf_token %}

          <!-- Hidden file input -->
          <input type="file"
            name="roster_csv"
            id="roster-csv-input"
            accept=".csv"
            class="hidden"
            onchange="document.getElementById('upload-roster-form').submit();" />

          <button type="button"
                  onclick="document.getElementById('roster-csv-input').click();"
                  class="btn-primary">
            <svg xmlns="http://www.w3.org/2000/svg"
                viewBox="0 0 20 20"
                fill="none"
                stroke="currentColor"
                class="h-4 w-4">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.7"
                    d="M5 13.5 10 7l5 6.5M10 7V16M4 4h12" />
            </svg>
            Upload Roster
          </button>
        </form>

        <!-- Add musician -->
        <a
          href="/musicians/"
          class="btn-secondary">
          <svg xmlns="http://www.w3.org/2000/svg"
               viewBox="0 0 20 20"
               fill="none"
               stroke="currentColor"
               class="h-4 w-4">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.7"
                  d="M10 4v12m6-6H4" />
          </svg>
          Add a Musician
        </a>
      </div>
    </div>

    <!-- Roster table card -->
    <div
      class="table-card"
      x-data="{ ...littleBIGtable({ url: '/api/musicians/search', limit: 25, messages: { loading: 'Loading roster...', failed: 'Unable to load roster right now.', summary: 'rows' } }), primaryInstrument(musician) { return musician?.instruments?.[0]?.instrument || null }, instrumentCount(musician) { return musician?.instruments?.length || 0 }, sectionPillClasses(sectionName) { const section = (sectionName || '').replace('–', '-').toLowerCase(); const base = 'inline-flex items-center rounded-full px-2.5 py-0.5 text-xs font-medium'; if (['violin','violin i','violin ii','viola','cello','double bass','bass'].includes(section) || section.startsWith('violin')) return `${base} bg-blue-100 text-blue-800`; if (['flute','piccolo','oboe','english horn','clarinet','bass clarinet','bassoon','contrabassoon'].includes(section)) return `${base} bg-green-100 text-green-800`; if (['horn','horn in f','french horn','trumpet','cornet','trombone','bass trombone','tuba'].includes(section)) return `${base} bg-yellow-100 text-yellow-800`; if (['percussion','timpani','drums','mallets'].includes(section)) return `${base} bg-pink-100 text-pink-800`; if (['piano','celesta','harpsichord','organ','harp'].includes(section)) return `${base} bg-purple-100 text-purple-800`; if (['soprano','alto','tenor','bass (choir)','choir','chorus'].includes(section)) return `${base} bg-red-100 text-red-900`; return `${base} bg-gray-100 text-gray-700`; } }"
      x-init="init()"
    >
      <!-- Table header: summary + filters -->
      <div class="table-toolbar">
        <div class="flex items-center gap-2">
          <p class="text-sm font-medium text-slate-800">
            All musicians
          </p>
          <span
            x-cloak
            x-show="!meta.loading && (params.total || 0) > 0"
            class="inline-flex items-center rounded-full bg-slate-100 px-2.5 py-0.5 text-xs font-medium text-slate-600"
          >
            <span x-text="params.total || 0"></span>&nbsp;total
          </span>
        </div>
        <div class="flex gap-2 w-full sm:w-auto">
          <!-- Optional: simple search -->
          <div class="table-search-wrap">
            <span class="pointer-events-none absolute inset-y-0 left-3 flex items-center text-slate-400">
              <svg xmlns="http://www.w3.org/2000/svg"
                   viewBox="0 0 20 20"
                   fill="none"
                   stroke="currentColor"
                   class="h-4 w-4">
                <circle cx="9" cy="9" r="4.5" stroke-width="1.5" />
                <path d="M12.5 12.5 15.5 15.5" stroke-width="1.5" stroke-linecap="round" />
              </svg>
            </span>
            <input
              type="text"
              name="search"
              placeholder="Search by name or email"
              x-model.debounce.300ms="params.search"
              @input.debounce.300ms="doSearch()"
              class="table-search-input pr-10"
            />
            <button
              type="button"
              class="search-clear-btn"
              x-cloak
              x-show="params.search"
              @click="params.search=''; doSearch()"
              aria-label="Clear search"
            >
              ✕
            </button>
          </div>
        </div>
      </div>

      <!-- Table -->
      <div class="table-responsive">
        <table class="table-base">
          <thead class="table-head">
            <tr>
              <th scope="col" class="table-th-first">
                First name
              </th>
              <th scope="col" class="table-th">
                Last name
              </th>
              <th scope="col" class="table-th">
                Section
              </th>
              <th scope="col" class="table-th">
                Email
              </th>
              <th scope="col" class="table-th">
                Principal
              </th>
              <th scope="col" class="table-th">
                Core Member
              </th>
            </tr>
          </thead>
          <tbody class="table-body">
            <template x-if="meta.loading">
              <tr>
                <td colspan="6" class="px-4 py-10 text-center">
                  <div class="inline-flex items-center gap-2 text-sm text-slate-500">
                    <span class="table-loading-spinner"></span>
                    Loading roster...
                  </div>
                </td>
              </tr>
            </template>
            <template x-if="!meta.loading && !rows.length">
              <tr>
                <td colspan="6" class="px-4 py-8 text-center text-sm text-slate-500">
                  No musicians yet. Upload your roster or add your first musician to get started.
                </td>
              </tr>
            </template>
            <template x-for="musician in rows" :key="musician.id">
              <tr class="table-row-clickable" @click="window.location.href=`/musicians/${musician.id}/`">
                  <td class="table-cell-first">
                    <span x-text="musician.first_name"></span>
                  </td>
                  <td class="table-cell">
                    <span x-text="musician.last_name"></span>
                  </td>
                  <td class="table-cell">
                    <template x-if="primaryInstrument(musician)">
                      <div class="flex items-center gap-2">
                        <span :class="sectionPillClasses(primaryInstrument(musician))" x-text="primaryInstrument(musician)"></span>
                        <span
                          x-show="instrumentCount(musician) > 1"
                          class="text-xs text-slate-500"
                          x-text="`+${instrumentCount(musician) - 1} more`"
                        ></span>
                      </div>
                    </template>
                    <template x-if="!primaryInstrument(musician)">
                      <span class="inline-flex items-center rounded-full bg-slate-100 px-2.5 py-0.5 text-xs font-medium text-slate-500">
                        Unassigned
                      </span>
                    </template>
                  </td>
                  <td class="table-cell text-slate-600">
                    <a :href="`mailto:${musician.email}`" class="hover:text-blue-700" @click.stop>
                      <span x-text="musician.email"></span>
                    </a>
                  </td>
                  <td class="table-cell text-slate-600 items-center">
                    <img x-show="musician.principal" class="w-3 h-3" src="/static/images/green_checkmark.png" />
                  </td>
                  <td class="table-cell text-slate-600 items-center">
                    <img x-show="musician.core_member" class="w-3 h-3" src="/static/images/green_checkmark.png" />
                  </td>
                </tr>
            </template>
          </tbody>
        </table>
      </div>

      <div class="table-footer">
        <p class="text-xs text-slate-500" x-html="meta.status"></p>
        <div class="flex items-center gap-2">
          <label class="text-xs text-slate-500" for="roster-page-size">Rows</label>
          <select
            id="roster-page-size"
            x-model.number="params.limit"
            @change="setLimit()"
            class="rounded-md border border-slate-200 bg-white px-2 py-1 text-xs text-slate-700"
          >
            <option value="10">10</option>
            <option value="25">25</option>
            <option value="50">50</option>
            <option value="100">100</option>
          </select>
          <button type="button" class="btn-secondary text-xs px-2 py-1" :disabled="meta.loading || getCurrentPage() <= 1" @click="goFirstPage()">First</button>
          <button type="button" class="btn-secondary text-xs px-2 py-1" :disabled="meta.loading || getCurrentPage() <= 1" @click="goPrevPage()">Prev</button>
          <span class="text-xs text-slate-600">
            Page <span x-text="getCurrentPage()"></span> / <span x-text="getTotalPages()"></span>
          </span>
          <button type="button" class="btn-secondary text-xs px-2 py-1" :disabled="meta.loading || getCurrentPage() >= getTotalPages()" @click="goNextPage()">Next</button>
          <button type="button" class="btn-secondary text-xs px-2 py-1" :disabled="meta.loading || getCurrentPage() >= getTotalPages()" @click="goLastPage()">Last</button>
        </div>
      </div>
    </div>
  </div>
{% endblock %}
