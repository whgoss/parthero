{% load pydantic_json %}
<!-- Program Pieces Tab -->
<div class="p-6" data-tab-panel="pieces" x-show="activeTab === 'pieces'">
    {{ pieces|pydantic_json_script:"selected-pieces-data" }}
    {{ program.checklist|pydantic_json_script:"program-checklist-data" }}
    
    <div x-data="programPieces('{{ program.id }}', JSON.parse(document.getElementById('selected-pieces-data').textContent), JSON.parse(document.getElementById('program-checklist-data').textContent))">
    <div class="flex items-center gap-3 mb-4">
        <p class="text-sm text-slate-500">
            Select pieces from your score library to add to this program.
        </p>
        <button
            type="button"
            class="btn-primary ml-auto disabled:bg-slate-300 disabled:border-slate-300 disabled:text-slate-500 disabled:opacity-100 disabled:cursor-not-allowed"
            :disabled="selectedPieces.length === 0"
            x-show="!completed"
            @click="markAsComplete()"
        >
            Mark Pieces as Complete
        </button>
        <button
            type="button"
            class="btn-primary-warning ml-auto disabled:bg-slate-300 disabled:border-slate-300 disabled:text-slate-500 disabled:opacity-100 disabled:cursor-not-allowed"
            x-show="completed == true"
            :disabled="saving || deliverySent"
            @click="markAsIncomplete()"
        >
            Mark Pieces as Incomplete
        </button>

    </div>
    <div class="rounded-lg border border-slate-200 bg-slate-50/60 p-4" x-ref="selectedPieces">
    <div class="flex items-center justify-between">
        <h2 class="text-sm font-semibold text-slate-800">Selected Pieces</h2>
        <span class="text-xs text-slate-500" x-text="`${selectedPieces.length} selected`"></span>
    </div>

    <template x-if="selectedPieces.length === 0">
        <div class="mt-3 text-sm text-slate-500">No pieces selected yet.</div>
    </template>

    <ul class="mt-3 space-y-2">
        <template x-for="piece in selectedPieces" :key="piece.id">
        <li class="flex items-center justify-between rounded-lg border border-slate-200 bg-white p-3">
            <div>
            <div class="text-sm font-medium text-slate-900" x-text="piece.title"></div>
            <div class="text-xs text-slate-500" x-text="piece.composer"></div>
            <div
                class="text-xs text-left"
                :class="piece.completed_parts < piece.parts_count ? 'text-red-500' : 'text-slate-500'"
            >
                <div>
                <span x-show="piece.completed_parts < piece.parts_count">⚠️</span>
                <span x-text="piece.completed_parts"></span>&nbsp;/&nbsp;<span x-text="piece.parts_count"></span> Parts
                </div>
            </div>
            </div>
            <button
                type="button"
                class="btn-danger"
                @click="removePiece(piece)"
                :disabled="completed">
                Remove
            </button>
        </li>
        </template>
    </ul>

    <div x-show="saving" class="mt-3 text-xs text-slate-500">Saving...</div>
    <div x-show="saveError" class="mt-3 text-xs text-red-600" x-text="saveError"></div>
    </div>

    <!-- Searching/Adding Pieces -->
    <div x-show="!completed" x-cloak>
        <hr class="my-6 border-slate-200">
        <div class="flex flex-wrap items-center mb-1">
            <h2 class="text-lg font-medium">Add Pieces to the Program</h2>
            <a href="/select_piece"
                class="btn-secondary ml-auto">
                <svg xmlns="http://www.w3.org/2000/svg"
                        viewBox="0 0 20 20"
                        fill="none"
                        stroke="currentColor"
                        class="h-4 w-4">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.7" d="M10 4v12m6-6H4" />
                </svg>
                New Piece
            </a>
            
        </div>
        
        <div>
        <p class="mb-4 text-sm text-slate-500">
            Search for pieces from your score library to add to this program.
        </p>
        </div>

        <div class="grid gap-3 sm:grid-cols-2">
            <div class="relative">
                <input
                type="text"
                class="form-input"
                placeholder="Search by title"
                x-model="title"
                @input.debounce.400ms="search()"
                />
                <button
                type="button"
                class="absolute right-2 top-1/2 -translate-y-1/2 rounded-full px-2 py-1 text-xs text-slate-400 hover:text-slate-600"
                x-show="title"
                @click="clearSearch()"
                aria-label="Clear search"
                >
                ✕
                </button>
            </div>
            <div class="relative">
                <input
                type="text"
                class="form-input pr-10"
                placeholder="Search by composer"
                x-model="composer"
                @input.debounce.400ms="search()"
                />
                <button
                type="button"
                class="absolute right-2 top-1/2 -translate-y-1/2 rounded-full px-2 py-1 text-xs text-slate-400 hover:text-slate-600"
                x-show="composer"
                @click="clearSearch()"
                aria-label="Clear search"
                >
                ✕
                </button>
            </div>
        </div>

        <div class="mt-4">
        <div x-show="loading" class="flex items-center gap-2 text-sm text-slate-500">
            <span class="inline-flex h-4 w-4 animate-spin rounded-full border-2 border-slate-300 border-t-slate-600"></span>
            Searching...
        </div>
        <div x-show="error" class="text-sm text-red-600" x-text="error"></div>

            <template x-if="!loading && hasSearched && results.length === 0">
                <div class="text-sm text-slate-500">No pieces found in your score library.</div>
            </template>

            <ul class="mt-3 space-y-2">
                <template x-for="piece in results" :key="piece.id">
                    <li
                        class="rounded-lg border border-slate-200 p-3 transition hover:bg-slate-50 cursor-pointer"
                        :class="isSelected(piece) ? 'border-blue-200 bg-blue-50 cursor-default' : ''"
                        @click="addPiece(piece)"
                    >
                        <div class="flex items-center justify-between">
                        <div>
                            <div>
                                <span class="inline-flex items-center justify-center rounded-md border border-green-200 bg-green-50 gap-2 px-2 py-1 text-xs font-medium text-green-700" x-show="isSelected(piece)">
                                    Selected
                                </span>
                                <span class="text-sm font-medium text-slate-900" x-text="piece.title"></span>
                            </div>
                            
                            <div class="text-xs text-slate-500" x-text="piece.composer"></div>
                        </div>
                        <div
                            class="text-xs text-right"
                            :class="piece.completed_parts < piece.parts_count ? 'text-red-500' : 'text-slate-500'"
                        >
                            <div>
                            <span x-show="piece.completed_parts < piece.parts_count">⚠️</span>
                            <span x-text="piece.completed_parts"></span>&nbsp;/&nbsp;<span x-text="piece.parts_count"></span> Parts
                            </div>
                        </div>
                        </div>
                    </li>
                </template>
            </ul>
        </div>
    </div>
  </div>
</div>
