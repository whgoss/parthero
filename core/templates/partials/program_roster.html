<!-- Program Roster Tab -->
<div
    class="p-6"
    data-tab-panel="roster"
    x-show="activeTab === 'roster'"
    x-data="{ ...programRoster('{{ program.id }}', JSON.parse(document.getElementById('program-checklist-initial-data').textContent)), ...littleBIGtable({ url: '/api/programs/{{ program.id }}/musicians/search', key_prefix: 'programRosterTable', limit: 25, messages: { loading: 'Loading program roster...', failed: 'Unable to load program roster right now.', summary: 'rows' } }) }"
    x-init="initProgramRoster(); init()"
>
    {{ instrument_options|json_script:"instrument-options" }}
    <div class="flex items-center gap-3 mb-4">
        <p class="text-sm text-slate-500">
            Build a program-specific roster by assigning musicians to sections.
        </p>
        <button
            type="button"
            class="btn-primary ml-auto disabled:bg-slate-300 disabled:border-slate-300 disabled:text-slate-500 disabled:opacity-100 disabled:cursor-not-allowed"
            x-show="!completed"
            :disabled="completed || saving"
            @click="markAsComplete()"
        >
            Mark Roster as Complete
        </button>
        <button
            type="button"
            class="btn-primary-warning ml-auto disabled:bg-slate-300 disabled:border-slate-300 disabled:text-slate-500 disabled:opacity-100 disabled:cursor-not-allowed"
            x-show="completed == true"
            :disabled="saving || deliverySent"
            @click="markAsIncomplete()"
        >
            Mark Roster as Incomplete
        </button>
    </div>

    <!-- Program Roster Table -->
    <div class="mt-4 table-card">
      <div class="table-toolbar">
        <div class="flex items-center gap-2">
          <p class="text-sm font-medium text-slate-800">Program musicians</p>
          <span
            x-cloak
            x-show="!meta.loading && (params.total || 0) > 0"
            class="inline-flex items-center rounded-full bg-slate-100 px-2.5 py-0.5 text-xs font-medium text-slate-600"
          >
            <span x-text="params.total || 0"></span>&nbsp;total
          </span>
        </div>
        <div class="flex gap-2 w-full sm:w-auto">
          <div class="table-search-wrap sm:w-72">
            <span class="pointer-events-none absolute inset-y-0 left-3 flex items-center text-slate-400">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="none" stroke="currentColor" class="h-4 w-4">
                <circle cx="9" cy="9" r="4.5" stroke-width="1.5" />
                <path d="M12.5 12.5 15.5 15.5" stroke-width="1.5" stroke-linecap="round" />
              </svg>
            </span>
            <input
              type="text"
              class="table-search-input pr-10"
              placeholder="Search program roster"
              x-model.debounce.300ms="params.search"
              @input.debounce.300ms="doSearch()"
            />
            <button
              type="button"
              class="search-clear-btn"
              x-cloak
              x-show="params.search"
              @click="params.search=''; doSearch()"
              aria-label="Clear roster search"
            >
              ✕
            </button>
          </div>
        </div>
      </div>

      <div class="table-responsive">
        <table class="table-base">
          <thead class="table-head">
            <tr>
              <th class="table-th-first">First Name</th>
              <th class="table-th">Last Name</th>
              <th class="table-th">Email</th>
              <th class="table-th">Principal</th>
              <th class="table-th">Sections / Instruments</th>
              <th class="table-th"></th>
            </tr>
          </thead>
          <tbody class="table-body text-slate-700">
            <template x-if="meta.loading">
              <tr>
                <td colspan="6" class="px-4 py-10 text-center">
                  <div class="inline-flex items-center gap-2 text-sm text-slate-500">
                    <span class="table-loading-spinner"></span>
                    Loading program roster...
                  </div>
                </td>
              </tr>
            </template>
            <template x-if="!meta.loading && !rows.length">
              <tr>
                <td class="px-4 py-8 text-sm text-slate-500 text-center" colspan="6">
                  No musicians assigned yet.
                </td>
              </tr>
            </template>
            <template x-for="program_musician in rows" :key="program_musician.id">
              <tr>
                <td class="table-cell-first" x-text="program_musician.first_name"></td>
                <td class="table-cell" x-text="program_musician.last_name"></td>
                <td class="table-cell" x-text="program_musician.email"></td>
                <td class="table-cell" x-text="program_musician.principal ? 'Yes' : 'No'"></td>
                <td class="table-cell">
                  <input
                    type="text"
                    class="form-input roster-instruments"
                    placeholder="Add sections or instruments"
                    :disabled="completed"
                    :value="rosterInstruments[program_musician.id] || formatInstrumentList(program_musician)"
                    @input="rosterInstruments[program_musician.id] = $event.target.value"
                    data-options-id="instrument-options"
                    :data-program-musician-id="program_musician.id"
                  />
                </td>
                <td class="table-cell">
                  <button
                    type="button"
                    class="btn-danger"
                    :disabled="completed || saving"
                    @click="removeMusician(program_musician)"
                  >
                    Remove
                  </button>
                </td>
              </tr>
            </template>
          </tbody>
        </table>
      </div>

      <div class="table-footer">
        <p class="text-xs text-slate-500" x-html="meta.status"></p>
        <div class="flex items-center gap-2">
          <label class="text-xs text-slate-500" for="program-roster-page-size">Rows</label>
          <select
            id="program-roster-page-size"
            x-model.number="params.limit"
            @change="setLimit()"
            class="rounded-md border border-slate-200 bg-white px-2 py-1 text-xs text-slate-700"
          >
            <option value="10">10</option>
            <option value="25">25</option>
            <option value="50">50</option>
            <option value="100">100</option>
          </select>
          <button type="button" class="btn-secondary text-xs px-2 py-1" :disabled="meta.loading || getCurrentPage() <= 1" @click="goFirstPage()">First</button>
          <button type="button" class="btn-secondary text-xs px-2 py-1" :disabled="meta.loading || getCurrentPage() <= 1" @click="goPrevPage()">Prev</button>
          <span class="text-xs text-slate-600">
            Page <span x-text="getCurrentPage()"></span> / <span x-text="getTotalPages()"></span>
          </span>
          <button type="button" class="btn-secondary text-xs px-2 py-1" :disabled="meta.loading || getCurrentPage() >= getTotalPages()" @click="goNextPage()">Next</button>
          <button type="button" class="btn-secondary text-xs px-2 py-1" :disabled="meta.loading || getCurrentPage() >= getTotalPages()" @click="goLastPage()">Last</button>
        </div>
      </div>
    </div>

    <!-- Add Musicians to Program Roster -->
    <div x-show="!completed" x-cloak>
        <hr class="my-6 border-slate-200" >
        <div class="flex flex-wrap items-center mb-4">
        <h2 class="text-lg font-medium">Add Musician to Program Roster</h2>

        <div class="ml-auto flex items-center gap-2">
            <!-- Load Principals -->
            <button
            type="button"
            class="btn-secondary"
            :disabled="completed || saving"
            @click="loadPrincipals()">
            Load Principals
            </button>

            <!-- Load Core Members -->
            <button
            type="button"
            class="btn-secondary"
            :disabled="completed || saving"
            @click="loadCoreMembers()">
            Load Core Members
            </button>

            <!-- Add a Musician -->
            <button
                href="/musicians/"
                class="btn-secondary"
                :disabled="completed || saving">
                <svg xmlns="http://www.w3.org/2000/svg"
                    viewBox="0 0 20 20"
                    fill="none"
                    stroke="currentColor"
                    class="h-4 w-4 shrink-0">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.7"
                            d="M10 4v12m6-6H4" />
                </svg>
                Add a Musician
            </button>
        </div>
        
        </div>
        <div>
            <p class="mb-4 text-sm text-slate-500">
            Add musicians from your master roster to this program.
            </p>
        </div>

        <!-- Musician Search -->
        <div class="grid gap-3 sm:grid-cols-2">
            <div class="relative">
                <input
                type="text"
                class="form-input"
                placeholder="Search by name"
                x-model="name"
                @input.debounce.400ms="search()"
                />
                <button
                type="button"
                class="absolute right-2 top-1/2 -translate-y-1/2 rounded-full px-2 py-1 text-xs text-slate-400 hover:text-slate-600"
                :disabled="completed"
                x-show="name"
                @click="clearSearch()"
                aria-label="Clear search"
                >
                ✕
                </button>
            </div>
            <div class="relative">
                <input
                type="text"
                class="form-input pr-10"
                placeholder="Search by instrument or section"
                x-model="instrument"
                @input.debounce.400ms="search()"
                />
                <button
                type="button"
                class="absolute right-2 top-1/2 -translate-y-1/2 rounded-full px-2 py-1 text-xs text-slate-400 hover:text-slate-600"
                :disabled="completed"
                x-show="instrument"
                @click="clearSearch()"
                aria-label="Clear search"
                >
                ✕
                </button>
            </div>
        </div>

        <div class="mt-4">
            <div x-show="loadingSearch" class="flex items-center gap-2 text-sm text-slate-500">
                <span class="inline-flex h-4 w-4 animate-spin rounded-full border-2 border-slate-300 border-t-slate-600"></span>
                Searching...
            </div>
            <div x-show="error" class="text-sm text-red-600" x-text="error"></div>
            <div x-show="saveError" class="mt-2 text-sm text-red-600" x-text="saveError"></div>

        <template x-if="!loadingSearch && hasSearched && results.length === 0">
            <div class="rounded-lg border border-dashed border-slate-200 bg-slate-50/60 p-4 text-sm text-slate-500">
            No musicians found.
            </div>
        </template>

        <ul class="mt-3 space-y-2">
            <template x-for="musician in results" :key="musician.id">
            <li
                class="rounded-lg border border-slate-200 p-3 transition hover:bg-slate-50 cursor-pointer"
                :class="isInRoster(musician) ? 'border-blue-200 bg-blue-50 cursor-default' : completed ? 'opacity-50 cursor-not-allowed' : ''"
                @click="!completed && addMusician(musician)"
            >
                <div class="flex items-center justify-between gap-3">
                <div>
                    <div>
                    <span
                        class="inline-flex items-center justify-center rounded-md border border-green-200 bg-green-50 gap-2 px-2 py-1 text-xs font-medium text-green-700"
                        x-show="isInRoster(musician)"
                    >
                        Selected
                    </span>
                    <span class="text-sm font-medium text-slate-900">
                        <span x-text="musician.first_name"></span>
                        <span x-text="musician.last_name"></span>
                    </span>
                    </div>
                    <div class="text-xs text-slate-500" x-text="musician.email"></div>
                </div>
                <div class="text-xs text-slate-500" x-text="formatInstrumentList(musician)"></div>
                </div>
            </li>
            </template>
        </ul>
        </div>
    </div>
</div>
