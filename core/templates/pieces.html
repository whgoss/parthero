{% extends "base.html" %}
{% block content %}
  <div class="max-w-5xl mx-auto">
    <div class="flex flex-col gap-4 lg:flex-row lg:items-start lg:justify-between mb-8">
      <div>
        <h1 class="page-header">Pieces</h1>
        <p class="mt-1 text-sm text-slate-500">
          Manage your orchestra's pieces and parts in one place.
        </p>
      </div>
      <div class="flex flex-wrap gap-2 sm:justify-end">
        <a href="/select_piece" class="btn-primary">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="none" stroke="currentColor" class="h-4 w-4">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.7" d="M10 4v12m6-6H4" />
          </svg>
          New Piece
        </a>
      </div>
    </div>

    <div
      class="table-card"
      x-data="{ ...littleBIGtable({ url: '/api/pieces/search', limit: 25, messages: { loading: 'Loading pieces...', failed: 'Unable to load pieces right now.', summary: 'rows' } }), completionLabel(piece) { return `${piece.completed_parts} / ${piece.parts_count}`; } }"
      x-init="init()"
    >
      <div class="table-toolbar">
        <div class="flex items-center gap-2">
          <p class="text-sm font-medium text-slate-800">All pieces</p>
          <span
            x-cloak
            x-show="!meta.loading && (params.total || 0) > 0"
            class="inline-flex items-center rounded-full bg-slate-100 px-2.5 py-0.5 text-xs font-medium text-slate-600"
          >
            <span x-text="params.total || 0"></span>&nbsp;total
          </span>
        </div>
        <div class="flex gap-2 w-full sm:w-auto">
          <div class="table-search-wrap sm:w-72">
            <span class="pointer-events-none absolute inset-y-0 left-3 flex items-center text-slate-400">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="none" stroke="currentColor" class="h-4 w-4">
                <circle cx="9" cy="9" r="4.5" stroke-width="1.5" />
                <path d="M12.5 12.5 15.5 15.5" stroke-width="1.5" stroke-linecap="round" />
              </svg>
            </span>
            <input
              type="text"
              name="search"
              placeholder="Search by title or composer"
              x-model.debounce.300ms="params.search"
              @input.debounce.300ms="doSearch()"
              class="table-search-input pr-10"
            />
            <button
              type="button"
              class="search-clear-btn"
              x-cloak
              x-show="params.search"
              @click="params.search=''; doSearch()"
              aria-label="Clear search"
            >
              âœ•
            </button>
          </div>
        </div>
      </div>

      <div class="table-responsive">
        <table class="table-base">
          <thead class="table-head">
            <tr>
              <th scope="col" class="table-th-first">Title</th>
              <th scope="col" class="table-th">Composer</th>
              <th scope="col" class="table-th text-right">Parts</th>
            </tr>
          </thead>
          <tbody class="table-body">
            <template x-if="meta.loading">
              <tr>
                <td colspan="3" class="px-4 py-10 text-center">
                  <div class="inline-flex items-center gap-2 text-sm text-slate-500">
                    <span class="table-loading-spinner"></span>
                    Loading pieces...
                  </div>
                </td>
              </tr>
            </template>
            <template x-if="!meta.loading && !rows.length">
              <tr>
                <td colspan="3" class="px-4 py-8 text-center text-sm text-slate-500">
                  No pieces have been created.
                </td>
              </tr>
            </template>
            <template x-for="piece in rows" :key="piece.id">
              <tr class="table-row-clickable" @click="window.location.href=`/pieces/${piece.id}/`">
                <td class="table-cell-first">
                  <span class="font-medium" x-text="piece.title"></span>
                </td>
                <td class="table-cell text-slate-700">
                  <span x-text="piece.composer"></span>
                </td>
                <td class="table-cell text-right">
                  <span class="inline-flex items-center rounded-full py-0.5 text-xs text-slate-700" x-text="completionLabel(piece)"></span>
                </td>
              </tr>
            </template>
          </tbody>
        </table>
      </div>

      <div class="table-footer">
        <p class="text-xs text-slate-500" x-html="meta.status"></p>
        <div class="flex items-center gap-2">
          <label class="text-xs text-slate-500" for="pieces-page-size">Rows</label>
          <select
            id="pieces-page-size"
            x-model.number="params.limit"
            @change="setLimit()"
            class="rounded-md border border-slate-200 bg-white px-2 py-1 text-xs text-slate-700"
          >
            <option value="10">10</option>
            <option value="25">25</option>
            <option value="50">50</option>
            <option value="100">100</option>
          </select>
          <button type="button" class="btn-secondary text-xs px-2 py-1" :disabled="meta.loading || getCurrentPage() <= 1" @click="goFirstPage()">First</button>
          <button type="button" class="btn-secondary text-xs px-2 py-1" :disabled="meta.loading || getCurrentPage() <= 1" @click="goPrevPage()">Prev</button>
          <span class="text-xs text-slate-600">
            Page <span x-text="getCurrentPage()"></span> / <span x-text="getTotalPages()"></span>
          </span>
          <button type="button" class="btn-secondary text-xs px-2 py-1" :disabled="meta.loading || getCurrentPage() >= getTotalPages()" @click="goNextPage()">Next</button>
          <button type="button" class="btn-secondary text-xs px-2 py-1" :disabled="meta.loading || getCurrentPage() >= getTotalPages()" @click="goLastPage()">Last</button>
        </div>
      </div>
    </div>
  </div>
{% endblock %}
