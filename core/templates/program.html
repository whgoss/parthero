{% extends "base.html" %}
{% load static %}
{% load roster %}
{% block content %}
<div class="max-w-5xl mx-auto">
    <!-- Top nav / breadcrumb -->
    <div class="flex items-center justify-between gap-4 mb-2">
      <a href="{% url 'programs' %}"
         class="inline-flex items-center text-sm font-medium text-slate-500 hover:text-slate-900">
        <svg xmlns="http://www.w3.org/2000/svg"
             viewBox="0 0 20 20"
             fill="none"
             stroke="currentColor"
             class="mr-1 h-4 w-4">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.6"
                d="M12.5 4.5 7 10l5.5 5.5" />
        </svg>
        Back to Programs
      </a>
    </div>

    <!-- Heading -->
    <div class="grid grid-cols-5 w-full gap-3 sm:flex-row sm:items-center sm:justify-between mb-6">
      <div class="col-span-4">
        <span class="page-header">
          {{ program.name }} [{{ program.status.value }}]
        </span>
        <h3 class="page-subheader">Step 2: Add Pieces to your Program.</h3>
      </div>
    </div>

    <!-- Basic Details -->
    <div class="bg-white border border-slate-200 shadow-sm rounded-xl p-6 mb-4">
      <h1 class="text-lg font-medium">Performance Dates</h1>
      {% for performance in program.performances %}
        <div class="text-sm font-light">
            {{ performance.date|date:"M j, Y h:i a" }}
        </div>
      {% endfor %}
    </div>

    <!-- Piece Management -->
    <div class="bg-white border border-slate-200 shadow-sm rounded-xl p-6 mb-4">
      <!-- Selected Pieces -->
      <h1 class="text-lg font-medium">Pieces</h1>
      {{ pieces_json|json_script:"selected-pieces-data" }}
      <div class="mt-4" x-data="programPieceSearch('{{ program.id }}', JSON.parse(document.getElementById('selected-pieces-data').textContent))">
        <div class="rounded-lg border border-slate-200 bg-slate-50/60 p-4" x-ref="selectedPieces">
          <div class="flex items-center justify-between">
            <h2 class="text-sm font-semibold text-slate-800">Selected Pieces</h2>
            <span class="text-xs text-slate-500" x-text="`${selectedPieces.length} selected`"></span>
          </div>

          <template x-if="selectedPieces.length === 0">
            <div class="mt-3 text-sm text-slate-500">No pieces selected yet.</div>
          </template>

          <ul class="mt-3 space-y-2">
            <template x-for="piece in selectedPieces" :key="piece.id">
              <li class="flex items-center justify-between rounded-lg border border-slate-200 bg-white p-3">
                <div>
                  <div class="text-sm font-medium text-slate-900" x-text="piece.title"></div>
                  <div class="text-xs text-slate-500" x-text="piece.composer"></div>
                  <div
                    class="text-xs text-left"
                    :class="piece.completed_parts < piece.parts_count ? 'text-red-500' : 'text-slate-500'"
                  >
                    <div>
                      <span x-show="piece.completed_parts < piece.parts_count">⚠️</span>
                      <span x-text="piece.completed_parts"></span>&nbsp;/&nbsp;<span x-text="piece.parts_count"></span> Parts
                    </div>
                  </div>
                </div>
                <button type="button" class="btn-danger" @click="removePiece(piece)">
                  Remove
                </button>
              </li>
            </template>
          </ul>

          <div x-show="saving" class="mt-3 text-xs text-slate-500">Saving...</div>
          <div x-show="saveError" class="mt-3 text-xs text-red-600" x-text="saveError"></div>
        </div>

        <!-- Searching/Adding Pieces -->
        <hr class="my-6 border-slate-200">
        <div class="flex flex-wrap items-center mb-4">
            <h2 class="text-sm font-semibold text-slate-800">Add Pieces to the Program</h2>
            <a href="/select_piece"
                class="btn-primary ml-auto">
                <svg xmlns="http://www.w3.org/2000/svg"
                        viewBox="0 0 20 20"
                        fill="none"
                        stroke="currentColor"
                        class="h-4 w-4">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.7" d="M10 4v12m6-6H4" />
                </svg>
                New Piece
            </a>
        </div>

        <div class="grid gap-3 sm:grid-cols-2">
          <div>
            <input
              type="text"
              class="block w-full rounded-xl border border-slate-200 px-3 py-2 text-sm shadow-sm focus:border-blue-500 focus:outline-none focus:ring-2 focus:ring-blue-100"
              placeholder="Search by title"
              x-model="title"
              @input.debounce.400ms="search()"
            />
          </div>
          <div>
            <input
              type="text"
              class="block w-full rounded-xl border border-slate-200 px-3 py-2 text-sm shadow-sm focus:border-blue-500 focus:outline-none focus:ring-2 focus:ring-blue-100"
              placeholder="Search by composer"
              x-model="composer"
              @input.debounce.400ms="search()"
            />
          </div>
        </div>

        <div class="mt-4">
          <div x-show="loading" class="flex items-center gap-2 text-sm text-slate-500">
            <span class="inline-flex h-4 w-4 animate-spin rounded-full border-2 border-slate-300 border-t-slate-600"></span>
            Searching...
          </div>
          <div x-show="error" class="text-sm text-red-600" x-text="error"></div>

          <template x-if="!loading && hasSearched && results.length === 0">
            <div class="text-sm text-slate-500">No pieces found.</div>
          </template>

          <ul class="mt-3 space-y-2">
            <template x-for="piece in results" :key="piece.id">
              <li
                class="rounded-lg border border-slate-200 p-3 transition hover:bg-slate-50 cursor-pointer"
                :class="isSelected(piece) ? 'border-blue-200 bg-blue-50 cursor-default' : ''"
                @click="addPiece(piece)"
              >
                <div class="flex items-center justify-between">
                  <div>
                    <div>
                        <span class="inline-flex items-center justify-center rounded-md border border-green-200 bg-green-50 gap-2 px-2 py-1 text-xs font-medium text-green-700" x-show="isSelected(piece)">
                            Selected
                        </span>
                        <span class="text-sm font-medium text-slate-900" x-text="piece.title"></span>
                    </div>
                    
                    <div class="text-xs text-slate-500" x-text="piece.composer"></div>
                  </div>
                  <div
                    class="text-xs text-right"
                    :class="piece.completed_parts < piece.parts_count ? 'text-red-500' : 'text-slate-500'"
                  >
                    <div>
                      <span x-show="piece.completed_parts < piece.parts_count">⚠️</span>
                      <span x-text="piece.completed_parts"></span>&nbsp;/&nbsp;<span x-text="piece.parts_count"></span> Parts
                    </div>
                  </div>
                </div>
              </li>
            </template>
          </ul>
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock %}
